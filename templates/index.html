{% extends 'base.html' %}
{% block title %}Главная — Tap Game{% endblock %}

{% block content %}
<h1>Привет, {{ user.username }}!</h1>

<div class="text-center my-4">
  <button id="tap-btn" class="btn btn-danger btn-lg px-5 py-3">Красная кнопка</button>
  <p class="mt-3">Нажато: <span id="click-count">{{ user.clicks }}</span></p>
</div>

<div id="win-alert" class="alert alert-success d-none" role="alert">
  Поздравляем! Ты выиграл 1₽ за 10000 нажатий!
</div>

<h3>Топ 10 игроков</h3>
<ol>
  {% for u in users %}
  <li {% if u.id == user.id %}class="fw-bold"{% endif %}>
    {{ u.username }} — {{ u.clicks }} нажатий
  </li>
  {% endfor %}
</ol>

<p>Твое место в рейтинге: <strong>{{ place }}</strong></p>

{% if user.is_admin %}
  <a href="{{ url_for('locations') }}" class="btn btn-primary">Посмотреть карту нажатий</a>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  const btn = document.getElementById('tap-btn');
  const clickCount = document.getElementById('click-count');
  const winAlert = document.getElementById('win-alert');

  btn.addEventListener('click', () => {
    fetch('/tap', {method: 'POST'})
      .then(res => res.json())
      .then(data => {
        clickCount.textContent = data.clicks;
        if (data.win) {
          winAlert.classList.remove('d-none');
          setTimeout(() => winAlert.classList.add('d-none'), 5000);
        }
      });
  });

  // Отправляем геолокацию
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      fetch('/location', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({lat: pos.coords.latitude, lon: pos.coords.longitude})
      });
    });
  }
</script>
{% endblock %}
